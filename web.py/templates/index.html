$def with (session)
<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="author" content="5IF" />
	<meta name="description" content="Gestion de vélos en ligne" />

	<title>Velo'V Unchained</title>
	<link rel="stylesheet" href="static/css/site.css" type="text/css" media="screen" charset="utf-8"/>
	<link rel="stylesheet" href="static/css/foundation.css" type="text/css" media="screen" charset="utf-8"/>

	<script src="static/js/modernizer.js"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD557QLPKAycHKwNmmviNQisn4UJ2Lg4IU&sensor=true"></script>

	<script type="text/javascript">

		//veloVs à charger dans la BDD
		//TODO : format d'export
		var veloPCV01 = JSON.parse('{"lat": 45.75,"long": 4.85,"nameVelo": "PCV01","etat": 0}');
		var veloPCV02 = JSON.parse('{"lat": 45.76,"long": 4.85,"nameVelo": "PCV02","etat": 0}');
		var veloPCV03 = JSON.parse('{"lat": 45.75,"long": 4.86,"nameVelo": "PCV03","etat": 0}');
		var veloVs = [];
		veloVs.push(veloPCV01);
		veloVs.push(veloPCV02);
		veloVs.push(veloPCV03);

		//Zones interdites
		var zone1 = JSON.parse('[{"lat": 45.772552,"long": 4.854326},{"lat": 45.772911,"long": 4.85836},{"lat": 45.784764,"long": 4.85939},{"lat": 45.783626,"long": 4.852009},{"lat": 45.780873,"long": 4.847374},{"lat": 45.777371,"long": 4.844885}]');
		var zones = [];
		zones.push(zone1);

		var googleMap;
		var oldLat = null;
		var oldLng = null;

		function initialize() {
			if(navigator.geolocation) {
			//initialise la map
				var mapOptions = {
					center: new google.maps.LatLng(45.7500000, 4.8500000),
					zoom: 13
				};
				googleMap = new google.maps.Map(document.getElementById("googleMap"),mapOptions);

				startLocalisation();

				//Affichage des vélos
				for(var i=0; i<veloVs.length; i++){
					showVeloVs(veloVs[i]);					
				}

				//Affichage des zones interdites
				for (var i=0; i<zones.length; i++){
					drawZones(zones[i]);
				}
			}
			else {
				alert('Votre navigateur ne supporte pas la géolocalisation HTML5');
			}
		}
		google.maps.event.addDomListener(window, 'load', initialize);
									 
		function startLocalisation() {
			//active le GPS
			var userPosition = navigator.geolocation.watchPosition(callbackSuccess, callbackError, {enableHighAccuracy: true});
		}
							 
		function callbackSuccess(position) {
			//récupère la latitude et la longitude
			var latitude = position.coords.latitude;
			var longitude = position.coords.longitude;
											 
			//trace un marqueur
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(latitude, longitude),
				map: googleMap
			});
										 
			//centre la map aux coordonnées voulue
			googleMap.panTo(new google.maps.LatLng(latitude, longitude));		 
		}
							 
		function callbackError(error) {
			switch(error.code) {
				case error.UNKNOWN_ERROR:
					alert("La géolocalisation a rencontré une erreur.");
				break;
				case error.PERMISSION_DENIED:
					alert("L'utilisateur n'a pas voulu donner sa position.");
				break;
				case error.POSITION_UNAVAILABLE:
					alert("Les coordonnées de l'utilisateur n'ont pas pu être trouvées.");
				break;
				case error.TIMEOUT:
					alert("La géolocalisation prend trop de temps.");
				break;
			}
		}

		function showVeloVs(velo){
			//trace un marqueur
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(velo.lat, velo.long),
				map: googleMap,
				title: "Hello World !"
			});
			console.log(velo);

			$if session:
				var contentString = writeContentString(velo,"$session['user_login']")
			$else:
				var contentString = '<h6>'+velo.nameVelo+'</h6>'+
				'<a disabled class="button">Réserver</a>&nbsp'+
				'<a disabled class="button">Prendre</a>';

			var infowindow = new google.maps.InfoWindow({
				content: contentString
			});

			google.maps.event.addListener(marker, 'click', function() {
				infowindow.open(googleMap,marker);
			});
		}

		function writeContentString(velo,util){
			return '<h6>'+velo.nameVelo+'</h6>'+
				'<a onclick=bookEvent(velo'+velo.nameVelo+',"'+util+'") class="button">Réserver</a>&nbsp'+
				'<a href="#" class="button">Prendre</a>';
		}

		function drawZones(zone){
			var coordPolygon = [];

			for (var j=0; j<zone.length; j++){
				coordPolygon.push(new google.maps.LatLng(zone[j].lat, zone[j].long));
			}

			// Construct the polygon.
			var zonePolygon = new google.maps.Polygon({
				paths: coordPolygon,
				strokeColor: '#FF0000',
				strokeOpacity: 0.8,
				strokeWeight: 2,
				fillColor: '#FF0000',
				fillOpacity: 0.35
			});

			zonePolygon.setMap(googleMap);

		}

		function bookEvent(velo) {
			jQuery.ajax({
		       	url: '/book', // La ressource ciblée
		       	type: 'POST', // Le type de la requête HTTP.
		       	data: 'velo=' + velo,
		       	dataType: "text",
		       	success: function(data){
		       		if (data == "OK"){
		       			jQuery('#bookOk').foundation('reveal', 'open');
		       			jQuery.ajax({
		       				url: 'http://maps.googleapis.com/maps/api/geocode/json',
		       				type: 'GET',
		       				data: 'latlng='+velo.lat+','+velo.long +'&sensor=true',
		       				dataType: "json",
		       				success: function(address){
		       					console.log(address);
		       					if (address.status == "OK"){
		       						jQuery('#addressVelo').html(address.results[0].formatted_address);
		       						console.log(address.results[0].formatted_address);
		       					}
		       					else{
		       						jQuery('#addressVelo').html("Adresse non trouvée");
		       					}
		       				}
		       			});
		       		}
		       	}
		    });
		}

	</script>
</head>
<body>

	<nav class="top-bar" data-topbar>
		<ul class="title-area">
			<li class="name">
				<h1><a href="#">Velo'V Unchained</a></h1>
			</li>
		</ul>

		<section class="top-bar-section">
			<!-- Right Nav Section -->
			<ul class="4-large columns right">
				$if session:
					<li class="name">
						<a>Bonjour $session['user_login']</a>
					</li>
					<li>
						<a href="/logout" class="button">Déconnexion</a>
					</li>
				$else:
					<li class="has-dropdown">
						<a class="button">Connexion</a>
						<ul class="dropdown">
							<li>
								<form method="post" action="">
									<input type="text" name="login" placeholder="Login" />
									<input type="password" name="password" placeholder="Password" />
									<input type="submit" name="submitlogin" value="Se connecter">
								</form>
							</li>	        	
						</ul>
					</li>
			</ul>
		</section>
	</nav>

	<div id="bookOk" class="reveal-modal" data-reveal>
		<h2>Vous avez réservé un vélo</h2>
		<p class="lead">Il est situé <span id="addressVelo"></span></p>
		<p class="lead">Il vous reste ... sec pour prendre le vélo</p>
		<a class="button">Prendre maintenant</a>
		<a class="alert button">Annuler la réservation</a> 
	</div>

	<div id="googleMap"/>

	<script src="static/js/jquery.js"></script>
	<script src="static/js/foundation.min.js"></script>
	<script>
		jQuery(document).foundation();
	</script>

</body>

</html>
