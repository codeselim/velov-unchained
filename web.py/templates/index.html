$def with (session)
<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="author" content="5IF" />
	<meta name="description" content="Gestion de vélos en ligne" />

	<title>Velo'V Unchained</title>
	<link rel="stylesheet" href="static/css/site.css" type="text/css" media="screen" charset="utf-8"/>
	<link rel="stylesheet" href="static/css/foundation.css" type="text/css" media="screen" charset="utf-8"/>

	<script src="static/js/modernizer.js"></script>
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD557QLPKAycHKwNmmviNQisn4UJ2Lg4IU&sensor=true"></script>

	<script type="text/javascript">

		//veloVs à charger dans la BDD
		//TODO : format d'export
		var veloPCV01 = JSON.parse('{"lat": 45.75,"long": 4.85,"nameVelo": "PCV01","etat": 0}');
		var veloPCV02 = JSON.parse('{"lat": 45.76,"long": 4.85,"nameVelo": "PCV02","etat": 0}');
		var veloPCV03 = JSON.parse('{"lat": 45.75,"long": 4.86,"nameVelo": "PCV03","etat": 0}');
		var veloVs = [];
		veloVs.push(veloPCV01);
		veloVs.push(veloPCV02);
		veloVs.push(veloPCV03);

		//Zones interdites
		var zone1 = JSON.parse('[{"lat": 45.772552,"long": 4.854326},{"lat": 45.772911,"long": 4.85836},{"lat": 45.784764,"long": 4.85939},{"lat": 45.783626,"long": 4.852009},{"lat": 45.780873,"long": 4.847374},{"lat": 45.777371,"long": 4.844885}]');
		var zones = [];
		zones.push(zone1);

		var googleMap;
		var oldLat = null;
		var oldLng = null;

		function initialize() {
			if(navigator.geolocation) {
			//initialise la map
				var mapOptions = {
					center: new google.maps.LatLng(45.7500000, 4.8500000),
					zoom: 13
				};
				googleMap = new google.maps.Map(document.getElementById("googleMap"),mapOptions);

				startLocalisation();

				//Affichage des vélos
				for(var i=0; i<veloVs.length; i++){
					showVeloVs(veloVs[i]);					
				}

				//Affichage des zones interdites
				for (var i=0; i<zones.length; i++){
					drawZones(zones[i]);
				}
			}
			else {
				alert('Votre navigateur ne supporte pas la géolocalisation HTML5');
			}

			//Ouverture de pop-up si utilisateur a une action en cours
		}
		google.maps.event.addDomListener(window, 'load', initialize);
									 
		function startLocalisation() {
			//active le GPS
			var userPosition = navigator.geolocation.watchPosition(callbackSuccess, callbackError, {enableHighAccuracy: true});
		}
							 
		function callbackSuccess(position) {
			//récupère la latitude et la longitude
			var latitude = position.coords.latitude;
			var longitude = position.coords.longitude;
											 
			//trace un marqueur
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(latitude, longitude),
				map: googleMap
			});
										 
			//centre la map aux coordonnées voulue
			googleMap.panTo(new google.maps.LatLng(latitude, longitude));		 
		}
							 
		function callbackError(error) {
			switch(error.code) {
				case error.UNKNOWN_ERROR:
					alert("La géolocalisation a rencontré une erreur.");
				break;
				case error.PERMISSION_DENIED:
					alert("L'utilisateur n'a pas voulu donner sa position.");
				break;
				case error.POSITION_UNAVAILABLE:
					alert("Les coordonnées de l'utilisateur n'ont pas pu être trouvées.");
				break;
				case error.TIMEOUT:
					alert("La géolocalisation prend trop de temps.");
				break;
			}
		}

		function showVeloVs(velo){
			//trace un marqueur
			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(velo.lat, velo.long),
				map: googleMap,
				title: "Hello World !"
			});

			$if session:
				var contentString = writeContentString(velo)
			$else:
				var contentString = '<h6>'+velo.nameVelo+'</h6>'+
				'<a disabled class="button">Réserver</a>&nbsp'+
				'<a disabled class="button">Prendre</a>';

			var infowindow = new google.maps.InfoWindow({
				content: contentString
			});

			google.maps.event.addListener(marker, 'click', function() {
				infowindow.open(googleMap,marker);
			});
		}

		function writeContentString(velo){
			return '<h6>'+velo.nameVelo+'</h6>'+
				'<a onclick=bookEvent(velo'+velo.nameVelo+') class="button">Réserver</a>&nbsp'+
				'<a onclick=takeEvent(velo'+velo.nameVelo+') class="button">Prendre</a>';
		}

		function drawZones(zone){
			var coordPolygon = [];

			for (var j=0; j<zone.length; j++){
				coordPolygon.push(new google.maps.LatLng(zone[j].lat, zone[j].long));
			}

			// Construct the polygon.
			var zonePolygon = new google.maps.Polygon({
				paths: coordPolygon,
				strokeColor: '#FF0000',
				strokeOpacity: 0.8,
				strokeWeight: 2,
				fillColor: '#FF0000',
				fillOpacity: 0.35
			});

			zonePolygon.setMap(googleMap);

		}

		function bookEvent(velo) {
			jQuery.ajax({
		       	url: '/book', // La ressource ciblée
		       	type: 'POST', // Le type de la requête HTTP.
		       	data: 'velo=' + velo,
		       	dataType: "text",
		       	success: function(data){
		       		if (data == "OK"){
		       			jQuery('#bookOk').foundation('reveal', 'open');
		       			//TODO récupérer date de la fin de la réservation
		       			time = new Date();
		       			printAddress(velo.lat,velo.long);
		       			bookTimer(time.getTime() + 300000);
		       		}
		       	}
		    });
		}

		function printAddress(lat,long,time){
			jQuery.ajax({
   				url: 'http://maps.googleapis.com/maps/api/geocode/json',
   				type: 'GET',
   				data: 'latlng='+lat+','+long +'&sensor=true',
   				dataType: "json",
   				success: function(address){
   					if (address.status == "OK"){
   						jQuery('#addressVelo').html(address.results[0].formatted_address);
   					}
   					else {
   						jQuery('#addressVelo').html("Impossible d'afficher l'adresse");
   					}
   				}
   			});
		}

		function takeEvent(velo){
			jQuery.ajax({
				url: '/take',
				type: 'POST',
				data: 'velo=' + velo,
				dataType: "text",
				success: function(data){
					if (data == "OK"){
		       			jQuery('#takeOk').foundation('reveal', 'open');
		       		}
				}
			});
		}

		function bookTimer(time) {
			now = new Date();
			restTime = (time - now.getTime());
			if (restTime < 0){
				jQuery('#bookEnd').foundation('reveal', 'open');
			}
			else{
				minutes = Math.floor(restTime / 60000);
				secondes = Math.round((restTime - minutes)/1000) % 60;
				timeHTML = minutes + " min " + secondes + " sec";
				document.getElementById("timeBookVelo").innerHTML = timeHTML;
				setTimeout("bookTimer(time)",1000);
			}
		}

	</script>
</head>
<body>

	<nav class="top-bar" data-topbar>
		<ul class="title-area">
			<li class="name">
				<h1><a href="#">Velo'V Unchained</a></h1>
			</li>
			<li class="toggle-topbar menu-icon"><a href="#"><span>Connexion</span></a></li> 
		</ul>

		<section class="top-bar-section">
			<!-- Right Nav Section -->
			<ul class="right">
				$if session:
					<li class="name">
						<a>Bonjour $session['user_login']</a>
					</li>
					<li>
						<a href="/logout" class="button">Déconnexion</a>
					</li>
				$else:
					<li class="has-form">
					<div class="row collapse">
						<form method="post" action="/">
							<li><input type="text" name="login" placeholder="Login" /></li>
							<li><input type="password" name="password" placeholder="Password" /></li>
							<li><input type="submit" class="button" name="submitlogin" value="Se connecter"></li>
						</form>
					</div>
					</li>
			</ul>
		</section>
	</nav>

	<div id="bookOk" class="reveal-modal" data-reveal>
		<h2>Vous avez réservé un vélo</h2>
		<p class="lead">Il est situé <span id="addressVelo"></span></p>
		<p class="lead">Il vous reste <span id="timeBookVelo"></span> pour prendre le vélo</p>
		<a onclick="takeEvent()" class="button">Prendre maintenant</a>
		<a class="alert button">Annuler la réservation</a> 
	</div>

	<div id="bookEnd" class="reveal-modal" data-reveal>
		<h2>Vous avez dépassé le temps imparti</h2>
		<p class="lead">Vous aviez 5 minutes pour prendre le vélo, vous allez avoir un blâme</span></p>
		<a class="close-reveal-modal">&#215;</a>
	</div>

	<div id="takeOk" class="reveal-modal" data-reveal>
		<h2>Vous avez un vélo en cours d'utilisation</h2>
		<p>Attention, vous avez 30 secondes pour déverrouiller le vélo</p>
	</div>

	<div id="googleMap"/>

	<script src="static/js/jquery.js"></script>
	<script src="static/js/foundation.min.js"></script>
	<script>
		jQuery(document).foundation();
	</script>

</body>

</html>
		       					
